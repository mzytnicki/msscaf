---
title: "10X analysis"
output: html_notebook
---

# Intro

## Data

Mail from Cédric.

> Les Long Reads :
>
> `/work/mzahm/Project_Pangafish/RawData/*.fastq.gz`
>
> Les reads Hi-C :
>
> `/work/mzahm/Project_Pangafish/RawData/HiC/*.fastq.gz`
>
> Les reads 10X :
>
> `/work/mzahm/Project_Pangafish/RawData/Run_PANGA1G.13800/Analyse_DemultiplexData.53847/*.fastq.gz`
>
> Le génome assemblé LR :
>
> `/work/project/sigenae/Christophe/Panga_longranger/map_to_scaffolds/genome.fa`
>
> Le bam Longranger :
>
> `/work/project/sigenae/Christophe/Panga_longranger/map_to_scaffolds/ALIGN/outs/possorted_bam.bam`
>
> Le fichier de comptage des tags 10X par bin de 10k :
>
> `/work/project/sigenae/Christophe/Panga_longranger/map_to_scaffolds/possorted-tagcmp.tsv.gz`
>
> Le fichier “contact map” simulé :
>
> `/work/project/sigenae/Christophe/Panga_longranger/map_to_scaffolds/genome.mnd.txt`
>
> Le fichier .hic généré à partir des données Hi-C :
>
> `/work/project/sigenae/Christophe/Panga_longranger/map_to_scaffolds/genome.final.10X.hic`
>
> Le fichier .hic généré à partir des données 10X :
>
> `/work/project/sigenae/Christophe/Panga_longranger/map_to_scaffolds/genome.final.Hi-C.hic`
>
> Le fichier .assembly du génome assemblé avec LR+Hi-C pour le chargement dans Juicebox :
>
> `/work/project/sigenae/Christophe/Panga_longranger/map_to_scaffolds/genome.final.assembly`
>
>
> La procédure utilisée pour générer un fichier .hic à partir de données 10X :
>
> http://genoweb.toulouse.inra.fr/~sigenae/10X_and_Juicebox.html


## Libraries

```{r}
library("MASS", pos = "package:base")
library("devtools")
library("magrittr")
library("tidyverse")
library("BiocParallel")
devtools::load_all(".")
```


## Loading data

The complete dataset
```{r}
# raw10X <- read_delim("/scratch/mazytnicki/possorted-tagcmp.tsv.gz",
#                      delim = " ",
#                      col_names = c("ref1", "bin1", "ref2", "bin2", "count"),
#                      col_types = "fifii")
# #better save it...
# saveRDS(object, "/Scratch/mazytnicki/bigData.rds")
object <- readRDS("/Scratch/mazytnicki/bigData.rds")
```

A small dataset, Scaff 001
```{r}
raw10X <- read_delim("possorted-tagcmp-short.tsv",
                     delim = " ",
                     col_names = c("ref1", "bin1", "ref2", "bin2", "count"),
                     col_types = "fifii")
```

Scaff 21
```{r}
raw10X <- read_delim("possorted-tagcmp-short-break2.tsv",
                     delim = " ",
                     col_names = c("ref1", "bin1", "ref2", "bin2", "count"),
                     col_types = "fifii")
```

Scaff 74
```{r}
raw10X <- read_delim("possorted-tagcmp-short-break3.tsv",
                     delim = " ",
                     col_names = c("ref1", "bin1", "ref2", "bin2", "count"),
                     col_types = "fifii")
```

Scaff 3
```{r}
raw10X <- read_delim("possorted-tagcmp-short-break4.tsv",
                     delim = " ",
                     col_names = c("ref1", "bin1", "ref2", "bin2", "count"),
                     col_types = "fifii")
```

A small dataset with scaffolding to do
```{r}
raw10X <- read_delim("possorted-tagcmp-short-orientation.tsv",
                     delim = " ",
                     col_names = c("ref1", "bin1", "ref2", "bin2", "count"),
                     col_types = "fifii")
```

Store into an object
```{r}
raw10X
object <- tenxcheckerExp(raw10X)
plot.10X(object)
```

## First steps

Clean data
```{r}
object <- estimateDistributions(object)
object <- cleanData(object)
gc()
```

```{r}
plot.10X(object)
```

Figures...
```{r}
p <- plotScaffoldSizeDistribution(object, log = FALSE)
p
```

```{r}
p <- plotCountDistribution(object, log = FALSE)
p
```

```{r}
p + xlim(-5, 100)
```

```{r}
plotCountDistribution(object, log = TRUE)
```

Plot intensity vs distance
```{r}
p <- plotMD(object, log = FALSE)
p
```

```{r}
p + xlim(0, 50) + ylim(0, 250)
    ```


```{r}
plotMD(object, log = TRUE)
```
```{r}
p <- plotRowCounts(object)
p
```

```{r}
plotRowCountDensity(object)
```

```{r}
p <- plotDiagonalStrength(object)
p
```


## Analysis

### Breaking chromosomes

```{r}
raw10X <- read_delim("possorted-tagcmp-short-break.tsv",
                     delim = " ",
                     col_names = c("ref1", "bin1", "ref2", "bin2", "count"),
                     col_types = "fifii")
object <- tenxcheckerExp(raw10X)
plot.10X(object)
object <- estimateDistributions(object)
object <- cleanData(object)
plot.10X(object)
breaks <- checkBreaks(object)
filteredBreaks <- filterBreaks(object, breaks$data)
object <- splitChromosomes(object, filteredBreaks$breaks)
plot.10X(object)
```

### Scaffolding chromosomes

```{r}
raw10X <- read_delim("possorted-tagcmp-short-orientation.tsv",
                     delim = " ",
                     col_names = c("ref1", "bin1", "ref2", "bin2", "count"),
                     col_types = "fifii")
object <- tenxcheckerExp(raw10X)
plot.10X(object)
object <- estimateDistributions(object)
object <- cleanData(object)
plot.10X(object)
joins <- checkJoins(object)
joins <- filterJoins(object, joins)
object <- scaffold(object, joins)
plot.10X(object)
```

### Finding short insertions

```{r}
insertions <- checkInsertions(object)
insertions$data %>% 
    filter(triangle > 0.5) %>%
    filter(rest < -0.5)
```
   ref             bin distance triangle  rest difference
   <fct>         <int>    <int>    <dbl> <dbl>      <dbl>
 1 PAHY_Scaf_069    80        2    0.825 -4.50       5.33
 2 PAHY_Scaf_069    84        2    0.898 -4.43       5.33
 3 PAHY_Scaf_069    79        3    0.610 -4.47       5.08
 4 PAHY_Scaf_069    85        3    0.693 -4.48       5.17
 5 PAHY_Scaf_069    78        4    0.507 -4.48       4.99
 6 PAHY_Scaf_069    86        4    0.553 -4.44       4.99
 7 PAHY_Scaf_088     5        2    1.01  -1.20       2.21
 8 PAHY_Scaf_088     6        3    0.633 -1.60       2.24
 9 PAHY_Scaf_101     5        2    0.765 -4.50       5.26
10 PAHY_Scaf_101     6        3    0.596 -4.52       5.11
11 PAHY_Scaf_154    41        2    0.634 -4.57       5.20
12 PAHY_Scaf_154    40        3    0.527 -2.50       3.03
13 PAHY_Scaf_174     7        4    0.536 -5.15       5.68

```{r}
raw10X <- read_delim("possorted-tagcmp-088.tsv",
                     delim = " ",
                     col_names = c("ref1", "bin1", "ref2", "bin2", "count"),
                     col_types = "fifii")
object <- tenxcheckerExp(raw10X)
object <- estimateDistributions(object)
object <- cleanData(object)
plot.10X(object)
plotInsertions2(extractRef(object, "PAHY_Scaf_088"), 5, 2)
```


```{r}
raw10X <- read_delim("possorted-tagcmp-069.tsv",
                     delim = " ",
                     col_names = c("ref1", "bin1", "ref2", "bin2", "count"),
                     col_types = "fifii")
object <- tenxcheckerExp(raw10X)
object <- estimateDistributions(object)
object <- cleanData(object)
plot.10X(object)
plotInsertions2(extractRef(object, "PAHY_Scaf_069"), 78, 4)
```
